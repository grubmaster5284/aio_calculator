name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Set up Android SDK (cmdline-tools)
        uses: android-actions/setup-android@v3
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Accept Android SDK licenses and install required NDK
        shell: bash
        run: |
          ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}
          echo "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          sdkmanager --version
          yes | sdkmanager --licenses || true
          sdkmanager "ndk;29.0.14033849"
      - name: Flutter Pub Get
        run: flutter pub get
      - name: Build Android APK (release)
        run: flutter build apk --release
      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Flutter Pub Get
        run: flutter pub get
      - name: Build Web (release)
        run: flutter build web --release
      - name: Archive Web bundle
        run: |
          cd build/web
          zip -r ../web-release.zip .
      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-zip
          path: build/web-release.zip

  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Linux desktop build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Flutter Pub Get
        run: flutter pub get
      - name: Build Linux (release)
        run: flutter build linux --release
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundle
          path: build/linux/**/release/**

  windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Enable long paths
        run: git config --system core.longpaths true
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Flutter Pub Get
        run: flutter pub get
      - name: Build Windows (release)
        run: flutter build windows --release
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-bundle
          path: build/windows/**/Runner/*.msi
          if-no-files-found: warn

  macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Flutter Pub Get
        run: flutter pub get
      - name: Build macOS (release)
        run: flutter build macos --release
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: build/macos/Build/Products/Release/*.app
          if-no-files-found: warn

  ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Flutter Pub Get
        run: flutter pub get
      - name: Build iOS (no codesign)
        run: flutter build ios --no-codesign
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/*.ipa
          if-no-files-found: warn

  release:
    runs-on: ubuntu-latest
    needs: [android, web, linux, windows, macos, ios]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: List artifacts
        run: |
          ls -R dist || true
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/android-apk/app-release.apk
            dist/web-zip/web-release.zip
            dist/linux-bundle/**/*
            dist/windows-bundle/**/*
            dist/macos-app/*.app
            dist/ios-build/*.ipa
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}


